<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Brahmavidya</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- THEME: LIQUID GLASS & NEON --- */
        :root {
            --glass-bg: rgba(20, 20, 20, 0.7);
            --glass-border: rgba(255, 255, 255, 0.1);
            --neon-blue: #00f2ff;
            --neon-gold: #ffd700;
            --neon-pink: #ff0099;
            --text-main: #ffffff;
        }

        body {
            margin: 0; font-family: 'Segoe UI', sans-serif;
            background: url('login_bg.png') no-repeat center center fixed;
            background-size: cover; color: var(--text-main);
            height: 100vh; overflow: hidden; -webkit-user-select: none;
        }

        /* --- UI COMPONENTS --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border); border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.5);
        }

        .screen { display: none; height: 100%; width: 100%; flex-direction: column; }
        .active { display: flex; }

        input, textarea {
            background: rgba(0,0,0,0.6); border: 1px solid var(--neon-blue);
            color: white; border-radius: 10px; padding: 12px; font-size: 16px; width: 100%; box-sizing: border-box; outline: none;
        }

        button {
            background: linear-gradient(90deg, var(--neon-blue), #0055ff);
            border: none; padding: 12px; border-radius: 10px; font-weight: bold; cursor: pointer; width: 100%;
            box-shadow: 0 0 10px var(--neon-blue); margin-top: 10px;
        }

        /* --- SCREENS --- */
        /* Login */
        #login-screen { justify-content: center; align-items: center; }
        
        /* Ovi (Lock) */
        #ovi-screen { justify-content: center; align-items: center; text-align: center; padding: 30px; }
        .ovi-box { border: 1px solid var(--neon-gold); padding: 15px; border-radius: 10px; color: var(--neon-gold); margin-top: 20px; }

        /* Dashboard */
        .navbar { height: 60px; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; background: rgba(0,0,0,0.8); }
        .cat-scroll { display: flex; overflow-x: auto; padding: 10px; gap: 10px; }
        .cat-chip { padding: 6px 15px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); white-space: nowrap; }
        .cat-chip.selected { background: var(--neon-blue); color: black; font-weight: bold; }
        
        .book-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding: 15px; overflow-y: auto; flex: 1; padding-bottom: 80px; }
        .book-card { padding: 10px; text-align: center; position: relative; }
        .book-cover { width: 100%; aspect-ratio: 2/3; object-fit: cover; border-radius: 8px; }
        .pin-btn { position: absolute; top: 5px; right: 5px; font-size: 20px; color: rgba(255,255,255,0.5); padding: 10px; }
        .pinned { color: var(--neon-gold); transform: scale(1.2); text-shadow: 0 0 5px black; }

        /* Reader */
        #reader-screen { background: #f4f4f4; color: #333; }
        .reader-header { height: 50px; background: white; display: flex; align-items: center; padding: 0 15px; justify-content: space-between; }
        #book-content { padding: 20px; flex: 1; overflow-y: auto; font-size: 18px; line-height: 1.8; text-align: justify; -webkit-user-select: text; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { width: 90%; max-height: 90%; display: flex; flex-direction: column; padding: 20px; }

        /* Chat */
        .chat-area { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; background: rgba(0,0,0,0.3); padding: 10px; border-radius: 10px; margin: 10px 0; }
        .msg { padding: 8px 12px; border-radius: 10px; max-width: 80%; }
        .msg-user { align-self: flex-end; background: var(--neon-blue); color: black; }
        .msg-admin { align-self: flex-start; background: rgba(255,255,255,0.2); border: 1px solid white; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <div class="glass-panel" style="padding: 40px; width: 80%; max-width: 350px; text-align: center;">
            <img src="logo.png" width="90" style="border-radius: 50%; box-shadow: 0 0 20px var(--neon-blue); margin-bottom: 20px;">
            <h3>Brahmavidya</h3>
            <input type="text" id="inp-name" placeholder="Full Name" style="margin-bottom: 15px;">
            <input type="text" id="inp-device" placeholder="Device Name (e.g. iPad)">
            <button onclick="login()">LOGIN</button>
        </div>
    </div>

    <div id="ovi-screen" class="screen">
        <div class="glass-panel" style="width: 85%; padding: 30px; text-align: center;">
            <i class="fas fa-lock" style="font-size: 50px; color: var(--neon-pink);"></i>
            <h3>Access Pending</h3>
            <p style="color: yellow;">Waiting for Admin...</p>
            <div class="ovi-box">
                "‡§∂‡•ç‡§∞‡•Ä‡§ï‡•É‡§∑‡•ç‡§£‡§∞‡§æ‡§µ‡•ã ‡§Æ‡•ç‡§π‡§£‡•á ‡§â‡§¶‡•ç‡§ß‡§µ‡§¶‡•á‡§µ‡§æ : ‡§π‡§æ ‡§ú‡•ç‡§û‡§æ‡§®‡§∞‡§§‡•ç‡§®‡§æ‡§ö‡§æ ‡§†‡•á‡§µ‡§æ :<br>‡§≠‡§≤‡•á‡§§‡§Ø‡§æ ‡§π‡§æ‡§§‡•Ä‡§Ç ‡§®‡•á‡§¶‡§æ‡§µ‡§æ : ‡§Ö‡§ß‡§ø‡§ï‡§æ‡§∞‡•á‡§Ç‡§µ‡•Ä‡§£ ‡•§‡•§"
            </div>
            <button onclick="checkAccess()" style="background: transparent; border: 1px solid var(--neon-blue); color: var(--neon-blue);">Check Status</button>
        </div>
    </div>

    <div id="dashboard-screen" class="screen">
        <div class="navbar">
            <i class="fas fa-user-circle" style="font-size: 24px; color: var(--neon-blue);" onclick="openSettings('profile')"></i>
            <span style="font-weight: bold; letter-spacing: 1px;">BRAHMAVIDYA</span>
            <i class="fas fa-bars" style="font-size: 24px;" onclick="openSettings('menu')"></i>
        </div>
        <div class="cat-scroll" id="cat-list"></div>
        <div class="book-grid" id="book-list"></div>
    </div>

    <div id="reader-screen" class="screen">
        <div class="reader-header">
            <i class="fas fa-arrow-left" onclick="closeBook()"></i>
            <span id="book-title" style="font-weight: bold;">Title</span>
            <i class="fas fa-bookmark" style="color: var(--neon-blue);"></i>
        </div>
        <div id="book-content"></div>
        <div style="position: fixed; bottom: 0; width: 100%; height: 50px; background: white; display: flex; align-items: center; padding: 0 10px;">
            <i class="fas fa-search" style="color: #666;"></i>
            <input type="text" id="search-input" placeholder="Search..." style="flex: 1; margin: 0 10px; background: #f0f0f0; color: black; border: none;" onkeyup="searchInBook()">
        </div>
    </div>

    <div id="settings-modal" class="modal-overlay">
        <div class="glass-panel modal-content">
            <i class="fas fa-times" onclick="closeModal()" style="position: absolute; top: 15px; right: 15px; font-size: 24px;"></i>
            <div id="modal-body" style="flex: 1; overflow-y: auto; margin-top: 20px;"></div>
        </div>
    </div>

    <script src="filelist.js"></script>

    <script>
        // üî• YOUR FIREBASE URL (No SDK needed) üî•
        const DB_URL = "https://adx-bk-default-rtdb.asia-southeast1.firebasedatabase.app";

        let user = { uid: localStorage.getItem('bv_uid'), name: localStorage.getItem('bv_name') };
        let categories = JSON.parse(localStorage.getItem('bv_cats')) || ['All', 'Nityanem', 'Pothi'];
        let pinned = JSON.parse(localStorage.getItem('bv_pinned')) || [];
        let currentCat = 'All';
        let checkInterval = null;

        // --- INIT & SYNC ---
        window.onload = () => {
            if(user.uid) { checkValidity(); startPolling(); }
            
            // üî• AUTOMATIC BOOK SYNC TO FIREBASE üî•
            if(typeof autoBookList !== 'undefined' && autoBookList.length > 0) {
                const updates = {};
                autoBookList.forEach(b => updates[b.name] = true);
                fetch(`${DB_URL}/library_catalog.json`, { method: 'PATCH', body: JSON.stringify(updates) });
            }
        };

        // --- LOGIN & VALIDITY ---
        function login() {
            const name = document.getElementById('inp-name').value.trim();
            const device = document.getElementById('inp-device').value.trim();
            if(!name || !device) return alert("Enter details");

            const uid = (name + "_" + device).replace(/[^a-zA-Z0-9]/g, "");
            user = { uid, name };
            
            localStorage.setItem('bv_uid', uid);
            localStorage.setItem('bv_name', name);
            localStorage.setItem('bv_device', device);
            localStorage.setItem('bv_login_date', Date.now());

            // Check if exists to preserve granted status
            fetch(`${DB_URL}/users/${uid}.json`).then(r=>r.json()).then(exist => {
                const data = { name, device, lastLogin: Date.now(), isBlocked: false };
                if(exist && exist.granted) data.granted = true; else data.granted = false;
                
                fetch(`${DB_URL}/users/${uid}.json`, { method: 'PUT', body: JSON.stringify(data) })
                    .then(() => { checkAccess(); startPolling(); });
            });
        }

        function checkValidity() {
            const date = parseInt(localStorage.getItem('bv_login_date') || 0);
            if((Date.now() - date) > (30*24*60*60*1000)) {
                if(navigator.onLine) localStorage.setItem('bv_login_date', Date.now());
                else { alert("Offline Validity Expired."); showScreen('login-screen'); return; }
            }
            checkAccess();
        }

        function checkAccess() {
            if(!user.uid) return showScreen('login-screen');
            fetch(`${DB_URL}/users/${user.uid}.json`).then(r=>r.json()).then(u => {
                if(u && u.granted && !u.isBlocked) loadDashboard();
                else showScreen('ovi-screen');
            }).catch(() => showScreen('ovi-screen'));
        }

        function startPolling() {
            if(checkInterval) clearInterval(checkInterval);
            checkInterval = setInterval(() => {
                if(document.getElementById('ovi-screen').classList.contains('active')) checkAccess();
            }, 5000);
        }

        // --- DASHBOARD ---
        function loadDashboard() { showScreen('dashboard-screen'); renderCats(); renderBooks(); }
        
        function renderCats() {
            document.getElementById('cat-list').innerHTML = categories.map(c => 
                `<div class="cat-chip ${currentCat===c?'selected':''}" onclick="currentCat='${c}'; renderCats(); renderBooks();">${c}</div>`
            ).join('') + `<div class="cat-chip" onclick="addCat()">+</div>`;
        }
        function addCat() {
            const n = prompt("New Category");
            if(n) { categories.push(n); localStorage.setItem('bv_cats', JSON.stringify(categories)); renderCats(); }
        }

        function renderBooks() {
            const grid = document.getElementById('book-list');
            grid.innerHTML = "";
            let list = (typeof autoBookList !== 'undefined') ? autoBookList : [];
            list.sort((a,b) => (pinned.includes(b.name)?1:0) - (pinned.includes(a.name)?1:0));
            list.forEach(b => {
                const isPin = pinned.includes(b.name);
                grid.innerHTML += `
                    <div class="glass-panel book-card">
                        <i class="fas fa-thumbtack pin-btn ${isPin?'pinned':''}" onclick="togglePin('${b.name}', event)"></i>
                        <img src="${b.image}" class="book-cover" onclick="openBook('${b.name}','${b.file}')">
                        <p style="margin-top:5px; font-size:14px;">${b.name}</p>
                    </div>`;
            });
        }
        function togglePin(n,e) {
            e.stopPropagation();
            if(pinned.includes(n)) pinned = pinned.filter(x=>x!==n); else pinned.push(n);
            localStorage.setItem('bv_pinned', JSON.stringify(pinned)); renderBooks();
        }

        // --- READER ---
        function openBook(n,f) {
            showScreen('reader-screen');
            document.getElementById('book-title').innerText=n;
            fetch(f).then(r=>r.text()).then(t => {
                const d = document.getElementById('book-content'); d.innerHTML=t;
                d.scrollTop = localStorage.getItem('pos_'+n) || 0;
                d.onscroll=()=>localStorage.setItem('pos_'+n, d.scrollTop);
            });
        }
        function closeBook() { showScreen('dashboard-screen'); }
        function searchInBook() { window.find(document.getElementById('search-input').value); }

        // --- SETTINGS ---
        function openSettings(type) {
            document.getElementById('settings-modal').style.display='flex';
            const body = document.getElementById('modal-body');
            
            if(type==='menu') {
                body.innerHTML = `<h2 style="text-align:center;">MENU</h2>
                <div onclick="openSettings('profile')" style="padding:15px; border-bottom:1px solid #333;">üë§ Profile</div>
                <div onclick="openSettings('about')" style="padding:15px; border-bottom:1px solid #333;">‚ÑπÔ∏è About Us</div>
                <div onclick="openSettings('feedback')" style="padding:15px;">üí¨ Chat</div>`;
            } else if(type==='about') {
                body.innerHTML = `
                    <button onclick="openSettings('menu')">Back</button>
                    <div style="margin-top:10px; color:#ddd; line-height:1.6; text-align:justify;">
                        <img src="photo1.jpg" style="width:100%; border-radius:10px;">
                        <h3 style="color:var(--neon-gold); text-align:center;">‡•• ‡§∂‡•ç‡§∞‡•Ä ‡§¶‡§§‡•ç‡§§‡§æ‡§§‡•ç‡§∞‡•á‡§Ø ‡§™‡•ç‡§∞‡§≠‡•Ç ‡§≠‡§ó‡§µ‡§æ‡§® ‡§ï‡•Ä ‡§ú‡§Ø ‡••</h3>
                        <p>"‡§ú‡•ç‡§Ø‡§æ‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•á ‡§Ü‡§ï‡§æ‡§∂‡§æ‡§§ ‡§∏‡•Ç‡§∞‡•ç‡§Ø ‡§§‡§≥‡§™‡§§ ‡§Ö‡§∏‡§§‡•ã ‡§Ü‡§£‡§ø ‡§§‡•ç‡§Ø‡§æ‡§ö‡•ç‡§Ø‡§æ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂‡§æ‡§®‡•á ‡§∏‡§Ç‡§™‡•Ç‡§∞‡•ç‡§£ ‡§µ‡§ø‡§∂‡•ç‡§µ ‡§â‡§ú‡§≥‡•Ç‡§® ‡§®‡§ø‡§ò‡§§‡•á, ‡§§‡•ç‡§Ø‡§æ‡§ö‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•á ‡§Ü‡§™‡§≤‡•ç‡§Ø‡§æ ‡§∏‡§æ‡§ß‡§ï‡§æ‡§Ç‡§ö‡•ç‡§Ø‡§æ ‡§Ü‡§Ø‡•Å‡§∑‡•ç‡§Ø‡§æ‡§§‡•Ä‡§≤ ‡§Ö‡§ú‡•ç‡§û‡§æ‡§®‡§æ‡§ö‡§æ ‡§Ö‡§Ç‡§ß‡§ï‡§æ‡§∞ ‡§¶‡•Ç‡§∞ ‡§ï‡§∞‡•Ç‡§® ‡§§‡•ç‡§Ø‡§æ‡§Ç‡§®‡§æ '‡§¨‡•ç‡§∞‡§π‡•ç‡§Æ‡§µ‡§ø‡§¶‡•ç‡§Ø‡•á‡§ö‡§æ' ‡§≤‡§ñ‡•ç‡§ñ ‡§™‡•ç‡§∞‡§ï‡§æ‡§∂ ‡§¶‡•á‡§£‡§æ‡§∞‡•á ‡§∏‡§æ‡§ï‡•ç‡§∑‡§æ‡§§ '‡§™‡•ç‡§∞‡§ú‡•ç‡§û‡§æ‡§∏‡•Ç‡§∞‡•ç‡§Ø' ‡§Æ‡•ç‡§π‡§£‡§ú‡•á ‡§™. ‡§™‡•Ç. ‡§™. ‡§Æ. ‡§∂‡•ç‡§∞‡•Ä ‡§Æ‡•ã‡§†‡•á ‡§¨‡§æ‡§¨‡§æ ‡§Ö‡§Ç‡§ï‡•Å‡§≥‡§®‡•á‡§∞‡§ï‡§∞ ‡§π‡•ã‡§§."</p>
                        <p>‡§Ø‡§æ ‡§µ‡§ø‡§∂‡•ç‡§µ‡§æ‡§§ ‡§∏‡•Ç‡§∞‡•ç‡§Ø‡§æ‡§ö‡•á ‡§∏‡•ç‡§•‡§æ‡§® ‡§Ö‡§¢‡§≥ ‡§Ü‡§π‡•á, ‡§∏‡•Ç‡§∞‡•ç‡§Ø ‡§ï‡§ß‡•Ä‡§π‡•Ä ‡§Æ‡§æ‡§µ‡§≥‡§§ ‡§®‡§æ‡§π‡•Ä, ‡§§‡•ã ‡§´‡§ï‡•ç‡§§ ‡§Ü‡§™‡§≤‡•Ä ‡§ú‡§æ‡§ó‡§æ ‡§¨‡§¶‡§≤‡§§‡•ã. ‡§Ö‡§ó‡§¶‡•Ä ‡§§‡•ç‡§Ø‡§æ‡§ö‡§™‡•ç‡§∞‡§Æ‡§æ‡§£‡•á, ‡§™. ‡§™‡•Ç. ‡§∂‡•ç‡§∞‡•Ä ‡§Æ‡•ã‡§†‡•á‡§¨‡§æ‡§¨‡§æ‡§Ç‡§ö‡•á ‡§Ö‡§∏‡•ç‡§§‡§ø‡§§‡•ç‡§µ ‡§Ü‡§£‡§ø ‡§§‡•ç‡§Ø‡§æ‡§Ç‡§ö‡•á ‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§Ü‡§ú‡§π‡•Ä ‡§Ö‡§ñ‡§Ç‡§° ‡§Ü‡§£‡§ø ‡§Ö‡§µ‡§ø‡§∞‡§§ ‡§∏‡•Å‡§∞‡•Ç ‡§Ü‡§π‡•á.</p>
                        <p style="text-align:center; font-weight:bold; color:var(--neon-blue);">‡§π‡•á ‡•≤‡§™, ‡§Ü‡§£‡§ø ‡§Ü‡§Æ‡§ö‡§æ ‡§π‡§æ ‡§õ‡•ã‡§ü‡§æ‡§∏‡§æ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§®, ‡§§‡•ç‡§Ø‡§æ ‡§Æ‡§π‡§æ‡§§‡•á‡§ú‡§∏‡•ç‡§µ‡•Ä '‡§™‡•ç‡§∞‡§ú‡•ç‡§û‡§æ‡§∏‡•Ç‡§∞‡•ç‡§Ø‡§æ'‡§ö‡•ç‡§Ø‡§æ ‡§ö‡§∞‡§£‡•Ä ‡§Ö‡§§‡•ç‡§Ø‡§Ç‡§§ ‡§µ‡§ø‡§®‡§Æ‡•ç‡§∞ ‡§≠‡§æ‡§µ‡§æ‡§®‡•á ‡§∏‡§Æ‡§∞‡•ç‡§™‡§ø‡§§ ‡§Ü‡§π‡•á.</p>
                        <hr>
                        <h3 style="color:var(--neon-gold); text-align:center;">‡•• ‡§¨‡•ç‡§∞‡§π‡•ç‡§Æ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ - ‡§∏‡•ç‡§µ‡§æ‡§ß‡•ç‡§Ø‡§æ‡§Ø ‡§Ü‡§£‡§ø ‡§ö‡§ø‡§Ç‡§§‡§® ‡••</h3>
                        <p>‡§π‡•á ‡•≤‡§™ ‡§Æ‡•ç‡§π‡§£‡§ú‡•á ‡§∏‡§æ‡§ß‡§ï‡§æ‡§Ç‡§∏‡§æ‡§†‡•Ä ‡§è‡§ï '‡§´‡§ø‡§∞‡§§‡•á ‡§ó‡•ç‡§∞‡§Ç‡§•‡§æ‡§≤‡§Ø' (Digital Library) ‡§Ü‡§π‡•á. ‡§Ø‡§æ‡§ö‡§æ ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§â‡§¶‡•ç‡§¶‡•á‡§∂ ‡§Ö‡§ñ‡§Ç‡§° ‡§∏‡•ç‡§µ‡§æ‡§ß‡•ç‡§Ø‡§æ‡§Ø, ‡§¶‡•Å‡§∞‡•ç‡§Æ‡§ø‡§≥ ‡§ó‡•ç‡§∞‡§Ç‡§• ‡§∞‡§ï‡•ç‡§∑‡§£ ‡§Ü‡§£‡§ø ‡§¨‡§æ‡§¨‡§æ‡§Ç‡§ö‡•á ‡§µ‡§ø‡§ö‡§æ‡§∞ ‡§™‡•ã‡§π‡•ã‡§ö‡§µ‡§£‡•á ‡§π‡§æ ‡§Ü‡§π‡•á.</p>
                        <h3 style="color:var(--neon-gold); text-align:center;">‡•• ‡§∂‡•ç‡§∞‡•Ä‡§¶‡§§‡•ç‡§§‡§æ‡§§‡•ç‡§∞‡•á‡§Ø‡§™‡•ç‡§∞‡§≠‡•Ç ‡§Æ‡§π‡§æ‡§∞‡§æ‡§ú ‡§ï‡•Ä ‡§ú‡§Ø ‡••</h3>
                        <img src="photo2.jpg" style="width:100%; border-radius:10px;">
                    </div>`;
            } else if(type==='profile') {
                body.innerHTML = `<button onclick="openSettings('menu')">Back</button><div style="text-align:center; margin-top:20px;"><h3>${user.name}</h3><p>Active</p></div>`;
            } else if(type==='feedback') {
                body.innerHTML = `<button onclick="openSettings('menu')">Back</button><div id="chat-msgs" class="chat-area">Loading...</div><div style="display:flex;"><input id="chat-in" style="flex:1;"><button onclick="sendMsg()">Send</button></div>`;
                loadChat();
            }
        }
        function closeModal() { document.getElementById('settings-modal').style.display='none'; }

        // Chat
        function loadChat() {
            fetch(`${DB_URL}/feedback/${user.uid}.json`).then(r=>r.json()).then(msgs => {
                const div = document.getElementById('chat-msgs'); if(!div) return; div.innerHTML = "";
                if(msgs) Object.values(msgs).forEach(m => {
                    if((Date.now()-m.timestamp) < 7*24*60*60*1000)
                        div.innerHTML += `<div class="msg ${m.sender==='admin'?'msg-admin':'msg-user'}">${m.text}</div>`;
                });
            });
        }
        function sendMsg() {
            const txt = document.getElementById('chat-in').value; if(!txt) return;
            fetch(`${DB_URL}/feedback/${user.uid}.json`, { method:'POST', body:JSON.stringify({text:txt, sender:'user', timestamp:Date.now()}) })
            .then(()=>{ document.getElementById('chat-in').value=""; loadChat(); });
        }

        function showScreen(id) { document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    </script>
</body>
</html>
